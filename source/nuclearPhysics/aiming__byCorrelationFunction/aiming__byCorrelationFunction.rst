##############################################################
相関関数を利用した照準位置決定
##############################################################

=========================================================
試料分布と放射線分布、相関関数
=========================================================

---------------------------------------------------------
定式化における仮定
---------------------------------------------------------

* RI製造量の位置ずれ特性は、規格化光子フラックス分布と規格化原料分布の相互相関関数で表せる．
* 簡単のため、1次元(位置をx)で考える．
* 位置毎の光子エネルギー特性が変化しない仮定のもとで考える．

  + 位置とエネルギー特性が独立．
  + 本来は微小散乱角方向に蹴られた光子は低エネルギー側にシフトし、エネルギー特性に特徴をもつことが類推される．
  + 一方で、50 MeV 中の 1 MeV ズレ等で、反応断面積はほぼ変わらないため、無視してよいと考える．
    

|

---------------------------------------------------------
式中記号の定義
---------------------------------------------------------

.. csv-table:: 
   :header: "記号", "意味", "単位"
   :widths: 20, 20, 10
   :width:  800px

   ":math:`x, \Delta x`", "位置、照準位置変位", "[m]"
   ":math:`E, E_l, E_u`", "エネルギー, 下限エネルギー, 上限エネルギー", "[MeV]"
   ":math:`t`", "試料平均厚み", "[m]"
   ":math:`\sigma(E)`", "反応断面積", "[b]"
   ":math:`N(x),N_n(x),N_0`", "試料分布, 規格化試料分布, 全粒子数", "[atoms/m], [a.u.], [atoms]"
   ":math:`\phi(x,\Delta x,E), \phi_E(E), \phi_n(x, \Delta x)`", "光子フラックス分布, エネルギー分布, 規格化光子フラックス分布", "[gammas/s/MeV], [a.u.], [gammas/s/MeV]"
   ":math:`Y(\Delta x)`", "RI製造率", "[atoms/s]"
   ":math:`C(\Delta x)`", "規格化試料分布と規格化光子フラックス分布の相互相関関数", "[a.u.]"

|
   
---------------------------------------------------------
定式化
---------------------------------------------------------

RI試料分布を :math:`N(x)` 、全粒子数を :math:`\int N(x) dx = N_0` として、規格化試料分布 :math:`N_n(x)` を以下で定義する．
  
.. math::

   N_n(x) = \dfrac{ N(x) }{ \int N(x) dx } = N(x)/N_0
     
     
照準位置変位 (:math:`\Delta x` )をもたせた放射線分布を :math:`\phi(x,\Delta x, E)` とすれば、照準位置変位ごとのRI製造量 :math:`Y (\Delta x)` は次のように表せる（他ページ参照）．

.. math::

   Y(\Delta x) = \int \int_{E_l}^{E_u} N(x) t \phi (x,\Delta x, E) \sigma (E) dx dE

ここで、t は均一の厚み、 :math:`\sigma(E)` はエネルギーごとの反応断面積である．
今、光子フラックスのエネルギーと位置は独立であると考えて、変数分離できると仮定する．

.. math::

   \phi(x,\Delta x, E) = \phi_n (x,\Delta x) \phi_E(E)

これを用いて、
   
.. math::

   Y(\Delta x) = t N_0 \int N_n(x) \phi_n(x,\Delta x) dx \int_{E_l}^{E_u} \phi_E(E) \sigma(E)dE

     
ここで、位置に関する積分について、

.. math::

   C (\Delta x) = \int N_n (x) \phi_n (x,\Delta x) dx

:math:`C(\Delta x)` は、規格化粒子分布 :math:`N_n(x)` と、規格化光子分布 :math:`\phi_n (x,\Delta x)` の相互相関関数である．

上記、相互相関関数以外の部分は、ビーム照射位置ずれに関係しない．
規格化試料分布と規格化光子フラックス分布の相互相関関数 :math:`C(\Delta x)` が最大となるような変位量 :math:`\Delta x` を求めれば、製造量を最大化できる．


=========================================================
数値計算
=========================================================

---------------------------------------------------------
コード
---------------------------------------------------------

.. literalinclude:: code/pyt/aiming__byCorrelationFunction.py
   		    :language: python

                               
---------------------------------------------------------
コンフィグファイル
---------------------------------------------------------

.. literalinclude:: code/cnf/settings.jsonc

                    
---------------------------------------------------------
データ
---------------------------------------------------------

.. literalinclude:: code/dat/distribution.dat


---------------------------------------------------------
実行結果
---------------------------------------------------------

.. literalinclude:: code/dat/output_sample.dat


---------------------------------------------------------
出力画像
---------------------------------------------------------

|

.. image:: code/png/aiming__byCorrelationFunction.png
   :width:  500px
   :align:  center

